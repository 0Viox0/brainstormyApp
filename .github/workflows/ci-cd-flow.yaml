on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -Eeuo pipefail

            echo "üöÄ Starting deployment"

            APP_DIR="$HOME/brainstormy"
            REPO_URL="git@github.com:Incept10n/brainstormy.git"
            BRANCH="master"

            if [ ! -d "$APP_DIR/.git" ]; then
              echo "üì¶ Cloning repository"
              git clone -b "$BRANCH" "$REPO_URL" "$APP_DIR"
            else
              echo "üì• Updating repository"
              cd "$APP_DIR"
              git fetch origin
              git checkout "$BRANCH"
              git pull origin "$BRANCH"
            fi

            cd "$APP_DIR"

            echo "üõë Stopping containers"
            docker compose down

            echo "üèó Building and starting containers"
            docker compose up --build -d

            echo "‚úÖ Deployment finished successfully"
