name: Main ci-cd build

on: 
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  # build_stage_back:
  #   name: build stage back image
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Login to Yandex Cloud Container Registry
  #       run: |
  #         echo ${{ secrets.YC_OAUTH }}|docker login \
  #          --username oauth \
  #          --password-stdin \
  #         cr.yandex

  #     - name: Build, tag, and push image to Yandex Cloud Container Registry
  #       env:
  #         CR_REGISTRY: crpt00fi0ka8gt8p6c56
  #         CR_REPOSITORY: stage/back
  #         IMAGE_TAG: main
  #       run: |
  #         cd backend
  #         docker build -t cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG .
  #         docker push cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG

  # build_stage_front:
  #   name: build stage front image
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Login to Yandex Cloud Container Registry
  #       run: |
  #         echo ${{ secrets.YC_OAUTH }}|docker login \
  #          --username oauth \
  #          --password-stdin \
  #         cr.yandex

  #     - name: Build, tag, and push image to Yandex Cloud Container Registry
  #       env:
  #         CR_REGISTRY: crpt00fi0ka8gt8p6c56
  #         CR_REPOSITORY: stage/front
  #         IMAGE_TAG: main
  #       run: |
  #         cd frontend
  #         docker build -t cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG \
  #           --build-arg VITE_BASE_URL=${{ vars.VITE_BASE_URL }} \
  #           --build-arg VITE_PROMPT_MAX_SYMBOLS=${{ vars.VITE_PROMPT_MAX_SYMBOLS }} \
  #           --build-arg VITE_FRONTEND_URL=${{ vars.VITE_FRONTEND_URL }} \
  #           .
  #         docker push cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG

  # dummy:
  #   runs-on: ubuntu-latest
  #   needs:
  #     - build_stage_back
  #     - build_stage_front
  #   steps:
  #     - name: Logical
  #       run: echo "Dummy job"

  # build_prod_back:
  #   name: build prod back image
  #   # needs: dummy
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Login to Yandex Cloud Container Registry
  #       run: |
  #         echo ${{ secrets.YC_OAUTH }}|docker login \
  #          --username oauth \
  #          --password-stdin \
  #         cr.yandex
 

  #     - name: Build, tag, and push image to Yandex Cloud Container Registry
  #       env:
  #         CR_REGISTRY: crpt00fi0ka8gt8p6c56
  #         CR_REPOSITORY: prod/back
  #         IMAGE_TAG: main
  #       run: |
  #         cd backend
  #         docker build -t cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG .
  #         docker push cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG
  
  # build_prod_front:
  #   name: build prod front image
  #   needs: dummy
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Login to Yandex Cloud Container Registry
  #       run: |
  #         echo ${{ secrets.YC_OAUTH }}|docker login \
  #          --username oauth \
  #          --password-stdin \
  #         cr.yandex
 

  #     - name: Build, tag, and push image to Yandex Cloud Container Registry
  #       env:
  #         CR_REGISTRY: crpt00fi0ka8gt8p6c56
  #         CR_REPOSITORY: prod/front
  #         IMAGE_TAG: main
  #       run: |
  #         cd frontend
  #         docker build -t cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG \
  #           --build-arg VITE_BASE_URL=${{ vars.VITE_BASE_URL }} \
  #           --build-arg VITE_PROMPT_MAX_SYMBOLS=${{ vars.VITE_PROMPT_MAX_SYMBOLS }} \
  #           --build-arg VITE_FRONTEND_URL=${{ vars.VITE_FRONTEND_URL }} \
  #           .
  #         docker push cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG

  # copy_docker_compose:
  #   name: copy docker compose and nginx config to remote
  #   needs: 
  #     - build_prod_front
  #     - build_prod_back
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Scp docker compose file and Nginx config
  #       run: |
  #         mkdir -p ~/.ssh
  #         echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
  #         chmod 600 ~/.ssh/id_rsa

  #         ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

  #         scp docker-compose.yaml $SERVER_USER@$SERVER_HOST:~/
  #         scp balancer/nginx.conf $SERVER_USER@$SERVER_HOST:~/
  #       env:
  #         SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  #         SERVER_HOST: ${{ secrets.SSH_HOST }}
  #         SERVER_USER: ${{ secrets.SSH_USER }}

  run_migrations:
    name: run migrations
    # needs: copy_docker_compose
    # needs: build_prod_back
    runs-on: ubuntu-latest
    steps:
      - name: Run migrations
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: CR_REGISTRY,CR_REPOSITORY,IMAGE_TAG,DATABASE_URL
          script: |
            echo ${{ secrets.YC_OAUTH }}|docker login \
             --username oauth \
             --password-stdin \
            cr.yandex

            docker run --rm \
             --name migration \
             --env "DATABASE_URL=$DATABASE_URL" \
             --entrypoint sh \
             cr.yandex/$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG \
             -c 'npx prisma migrate deploy'

        env:
          CR_REGISTRY: crpt00fi0ka8gt8p6c56
          CR_REPOSITORY: prod/back
          IMAGE_TAG: main
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
  
  deploy_prod:
    name: deploy prod
    needs: run_migrations
    runs-on: ubuntu-latest
    steps:
      - name: Deploy the app using docker compose
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: API_TOKEN,FOLDER_ID,ENVIRONMENT,YANDEX_CLIENT_SECRET,YANDEX_CLIENT_ID,DATABASE_URL
          script: |
            echo ${{ secrets.YC_OAUTH }}|docker login \
             --username oauth \
             --password-stdin \
            cr.yandex

            echo "üõë Stopping containers"
            docker compose down
            docker system prune -a -f
                  
            echo "üèó Building and starting containers"
            docker compose build
            docker compose up -d
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
          FOLDER_ID: ${{ secrets.FOLDER_ID }}
          ENVIRONMENT: ${{ vars.ENVIRONMENT }}
          YANDEX_CLIENT_SECRET: ${{ secrets.YANDEX_CLIENT_SECRET }}
          YANDEX_CLIENT_ID: ${{ secrets.YANDEX_CLIENT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
